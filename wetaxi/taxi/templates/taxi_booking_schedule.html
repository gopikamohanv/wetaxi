{% extends "taxi_base.html" %}

{% block custom_css %}
	<link rel="stylesheet" href="/static/js/calendar/css/calendar.css">
  <link rel="stylesheet" href="/static/js/datetimepicker/css/bootstrap-datetimepicker.css">
  <style>
  .modal .modal-body {
    max-height: 550px;
    overflow-y: auto;
}
  </style>
{% endblock %}

{% block content %}
		<div class="row">
        <!-- Page Header -->
        <div class="col-lg-12">
            <h1 class="page-header">
            	Booking Schedule
            	<div class="col-md-3 pull-right">
            		<form action="/taxi/booking/schedule/" type="GET" id="taxiTypeFrm">
		            	<select name="type" id="filterTaxi" class="form-control">
		            		<option value="">Filter By</option>
		            		{% for type in taxi_types %}
		            		<option value="{{type.id}}">{{type.taxi_type}}</option>
		            		{% endfor %}
		            	</select>
		            </form>
	            </div>
            </h1>
        </div>
        <!--End Page Header -->
    </div>
    <div class="row">
    	{% for taxi in taxis %}
			<div class="col-lg-3">
      	<div class="alert alert-warning text-center">
          	{{taxi.display_name}}<br>
          	<img src="{{taxi.icon_url}}" width="120px;" height="100px;">
          	<p>{{taxi.taxi_number}}</p>
          	<p>Model : {{taxi.taxi_model}}</p>
          	<p>Passengers : {{taxi.seat_capacity}}</p><br>
          	<button class="btn btn-primary schedule" taxi="{{taxi.id}}" name="{{taxi.display_name}}">Schedule</button>
      	</div>
 			</div>
 			{% empty %}
 			<div class="alert alert-info">
 				No Taxis available.
 			</div>
			{% endfor %}	
    </div>

    <div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    	<div class="modal-dialog modal-lg">
       	<div class="modal-content">
          <div class="modal-header calendar-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
              <h3></h3>
          </div>
          <div class="modal-body">
          	<div class="row">
	    				<div class="col-lg-12">									
								<div class="pull-right">
            			<div class="btn-group">
                		<button class="btn btn-xs btn-primary" data-calendar-nav="prev">
                    	<span class="entypo-left-circled"></span>Prev</button>
                		<button class="btn btn-xs " data-calendar-nav="today">Today</button>
                		<button class="btn btn-xs btn-primary" data-calendar-nav="next">Next
                    	<span class="entypo-right-circled"></span>
                		</button>
            			</div>
            			<div class="btn-group">
                    <button class="btn btn-xs btn-warning" data-calendar-view="year">Year</button>
                    <button class="btn btn-xs btn-warning active" data-calendar-view="month">Month</button>
                    <button class="btn btn-xs btn-warning" data-calendar-view="week">Week</button>
                    <button class="btn btn-xs btn-warning" data-calendar-view="day">Day</button>
	                </div>
        				</div>
        				<br><br>
								<div id="calendar"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
    </div>
    

    <div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>Booking Details</h3>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <form class="form-horizontal" role="form" onsubmit="return formSubmit()">
                  <div class="form-group">
                    <label class="col-sm-2 control-label">Taxi</label>
                    <div class="col-sm-10">
                      <input type="email" class="form-control" id="taxiname" readonly placeholder="">
                    </div>
                  </div>
                  <div class="form-group" id="startDateControlGroup">
                      <label class="col-sm-2 control-label" for="startDate">Start Date</label>
                      <div class="col-sm-10">
                        <div class="input-group date datetimepicker">
                          <input type="text" class="form-control" readonly id="fromDate" />
                          <span class="input-group-addon"><i class="glyphicon-calendar glyphicon"></i></span>
                        </div>
                      </div>
                  </div>
                  <div class="form-group" id="endDateControlGroup">
                      <label class="col-sm-2 control-label" for="endDate">End Date</label>
                      <div class="col-sm-10">
                        <div class="input-group date datetimepicker">
                          <input type="text" class="form-control" readonly id="toDate" />
                          <span class="input-group-addon"><i class="glyphicon-calendar glyphicon"></i></span>
                        </div>
                      </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label">To</label>
                    <div class="col-sm-10">
                      <select id="passenger" class="form-control" required>
                        <option value="">Select Passenger</option>
                        {% for passenger in passengers %}
                          <option value="{{passenger.user.id}}">{{passenger.user.first_name}}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                      <button type="submit" class="btn btn-warning">Book Now</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" id="taxiId" value="">
    <input type="hidden" id="taxiName" value="">
    <input type="hidden" id="csrf" value="{{csrf_token}}">
{% endblock %}

{% block custom_js %}
	<script type="text/javascript" src="/static/js/calendar/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="/static/js/calendar/jstimezonedetect/jstz.min.js"></script>
	<script type="text/javascript" src="/static/js/calendar/calendar.js"></script>
	<script type="text/javascript" src="/static/js/calendar/app.js"></script>
  
  <script type="text/javascript" src="/static/js/datetimepicker/js/moment.js"></script>
  <script type="text/javascript" src="/static/js/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>

	<script>
		$('#filterTaxi').change(function(e) {
			if($(this).val() === ''){
				return;
			}
			$('#taxiTypeFrm').submit()
		});
		$('.schedule').click(function(e) {
			e.preventDefault();
      $('#calendarModal').modal({
        backdrop:'static',
        keyboard: false
      }); 
      var taxi = $(this).attr('taxi')
      $('#taxiId').val(taxi);
      $('#taxiName').val($(this).attr('Name'));
      var calendar = $('#calendar').calendar({events_source: '/taxi/schedule/events/?taxi=' + taxi, tmpl_path: '/static/js/calendar/tmpls/'});
		});
    function hello(){
      $('#bookingModal').modal({
        backdrop:'static',
        keyboard: false
      }); 
      $('#taxiname').val($('#taxiName').val());
      $('#calendarModal').modal('hide');
      $('#bookingModal').css('margin-top', '150px')
    }
    $('#bookingModal').on('hidden.bs.modal', function() {
      $('#calendarModal').modal('show');
    });
    function formSubmit(){
      var fromDate = $('#fromDate').val();
      var toDate = $('#toDate').val();
      if (fromDate === ''){
        alert('Start Date is empty!!');
        return false;
      }
      if (toDate === ''){
        alert('End Date is empty!!');
        return false;
      }
      var passenger = $('#passenger').val();
      var taxi = $('#taxiId').val();
      var csrf = $('#csrf').val();
      $.ajax({
        url: '/taxi/booking/' + taxi + '/',
        type: 'POST',
        data: {from:fromDate, to:toDate, passenger:passenger, csrfmiddlewaretoken:csrf},
      })
      .done(function(data) {
        if (data.status === false){
          alert(data.message)
        }
        else{
          alert(data.message);
          $('#bookingModal').modal('hide');
          var calendar = $('#calendar').calendar({events_source: '/taxi/schedule/events/?taxi=' + taxi, tmpl_path: '/static/js/calendar/tmpls/'});
        }
      })
      .fail(function() {
        alert('An error occured please try again!!');
        return false
      })
      
      return false;
    }
    $(function() {
      $('.datetimepicker').datetimepicker();
    });
	</script>
{% endblock %}